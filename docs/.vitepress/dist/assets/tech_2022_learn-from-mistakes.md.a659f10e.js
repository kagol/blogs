import{_ as a,B as s,o as n,c as o,G as t,Q as l}from"./chunks/framework.1fee3549.js";const h=JSON.parse('{"title":"从错误中学习：分享 Vue DevUI 组件库开发过程中遇到的一些问题","description":"","frontmatter":{},"headers":[],"relativePath":"tech/2022/learn-from-mistakes.md","filePath":"tech/2022/learn-from-mistakes.md"}'),i={name:"tech/2022/learn-from-mistakes.md"},p=l(`<h1 id="从错误中学习-分享-vue-devui-组件库开发过程中遇到的一些问题" tabindex="-1">从错误中学习：分享 Vue DevUI 组件库开发过程中遇到的一些问题 <a class="header-anchor" href="#从错误中学习-分享-vue-devui-组件库开发过程中遇到的一些问题" aria-label="Permalink to &quot;从错误中学习：分享 Vue DevUI 组件库开发过程中遇到的一些问题&quot;">​</a></h1><p><img src="https://user-images.githubusercontent.com/9566362/201511264-8b55b842-cc14-4e87-a398-ba2fe46f5816.png" alt="image"></p><p>DevOps理论中有一个很重要的观点：在复杂的系统中工作时，我们不可能预测到所有的结果。</p><p>因此错误或缺陷在所难免，我们要将错误视作机会，学习和自我改进的机会，当我们深刻理解了错误，我们就能避免下一次更严重的错误。</p><p><a href="https://gitee.com/devui/vue-devui" target="_blank" rel="noreferrer">Vue DevUI</a> 是 Vue3 版本的 DevUI 组件库，基于 <a href="https://devui.design/" target="_blank" rel="noreferrer">Ng DevUI</a>。</p><p>Vue DevUI 使用最新的技术栈进行开发：</p><ul><li>使用<code>Vite</code>搭建基础工程（<a href="https://juejin.cn/post/7017101147865350158" target="_blank" rel="noreferrer">【我要做开源】Vue DevUI开源指南04：使用Vite搭建一个支持TypeScript/JSX的Vue3组件库工程 </a>）</li><li>使用<code>VitePress</code>搭建文档系统（<a href="https://juejin.cn/post/7019314307682795534" target="_blank" rel="noreferrer">【我要做开源】Vue DevUI开源指南05：给Vue3组件库添加VitePress文档系统</a>）</li><li>使用<code>Vue3</code>+<code>TypeScript</code>+<code>JSX</code>进行组件开发（<a href="https://juejin.cn/post/7015023354847428645" target="_blank" rel="noreferrer">【我要做开源】Vue DevUI开源指南03：如何给 tree 组件增加展开/收起功能</a>）</li><li>使用<code>Jest</code>+<code>@vue/test-utils</code>进行单元测试</li><li>使用<code>eslint</code>/<code>stylelint</code>/<code>ls-lint</code>进行代码规范检查</li></ul><p>在开发 Vue DevUI 的过程中，我们也遇到不少问题：</p><ol><li>有些是我们的contributor提的issue</li><li>有些在和村长直播过程中发现的问题</li><li>还有一些和VitePress文档系统相关</li></ol><p>以下是本文将要分享的问题列表：</p><ul><li>8.16 <a href="https://gitee.com/devui/vue-devui/issues/I45VB6" target="_blank" rel="noreferrer">vitepress中使用自定义指令导致的问题</a></li><li>9.18 defineEmit导致的文档启动白页问题</li><li>10.3 <a href="https://gitee.com/devui/vue-devui/issues/I4D06D" target="_blank" rel="noreferrer">使用window浏览器变量导致的vitepress ssr构建问题</a></li></ul><h2 id="问题一-vitepress中使用自定义指令导致的问题" tabindex="-1">问题一：vitepress中使用自定义指令导致的问题 <a class="header-anchor" href="#问题一-vitepress中使用自定义指令导致的问题" aria-label="Permalink to &quot;问题一：vitepress中使用自定义指令导致的问题&quot;">​</a></h2><h3 id="问题背景和描述" tabindex="-1">问题背景和描述 <a class="header-anchor" href="#问题背景和描述" aria-label="Permalink to &quot;问题背景和描述&quot;">​</a></h3><p>第一个问题最早可以追溯到8月16日，由<code>vue devui</code>的早期贡献者<a href="https://gitee.com/laiweilun" target="_blank" rel="noreferrer">wailen</a>提出 <a href="https://gitee.com/devui/vue-devui/issues/I45VB6" target="_blank" rel="noreferrer">I45VB6</a>，当时<code>vue devui</code>的文档系统刚刚切换到<code>vitepress</code>一个多星期。</p><p>以下是<code>wailen</code>同学当时提的issue：</p><p><a href="https://gitee.com/devui/vue-devui/issues/I45VB6" target="_blank" rel="noreferrer">yarn build时会报错（loading组件报错）</a></p><p>当时通过执行<code>yarn build</code>文档构建命令就可以很轻易地复现该错误：</p><p>报错信息如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">SyntaxError: Custom directive is missing corresponding SSR transform and will be ignored.</span></span></code></pre></div><p>以下是当时<code>wailen</code>的截图：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/989ca47033a24fb98be9def1ab64a08a~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>不过当时<code>vue devui</code>项目刚开始活跃，大家都忙着提交pr、提交issue、检视和合入代码，没有太关注到这个issue，而且当时咱们的网站还没有通过域名访问，不需要部署实际的主机，也就不需要执行<code>yarn build</code>构建生产包，因此都没关注到这个问题。</p><h3 id="问题分析" tabindex="-1">问题分析 <a class="header-anchor" href="#问题分析" aria-label="Permalink to &quot;问题分析&quot;">​</a></h3><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c66ed40af194a1dacd54358ce602c68~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>看截图的报错信息，是<code>vitepress</code>构建过程中遇到了语法错误导致构建失败，提示<code>自定义指令缺少服务端渲染的转换器</code>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">SyntaxError: Custom directive is missing corresponding SSR transform and will be ignored.</span></span></code></pre></div><p>很幸运，报错提示定位到了具体的文件：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">file: D:/code/vue-devui/sites/components/loading/index.md:124:3</span></span></code></pre></div><p>这个文件是<code>Loading</code>组件的md文档，以下是会导致构建错误的内容：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">&lt;div</span></span>
<span class="line"><span style="color:#babed8;">  v-dLoading=&quot;promises.value&quot;</span></span>
<span class="line"><span style="color:#babed8;">  :backdrop=&quot;true&quot;</span></span>
<span class="line"><span style="color:#babed8;">  message=&quot;One moment please...&quot;</span></span>
<span class="line"><span style="color:#babed8;">  style=&quot;margin-top: 20px; width: 100%; height: 80px; padding: 10px;&quot;</span></span>
<span class="line"><span style="color:#babed8;">&gt;loading will show here2&lt;/div&gt;</span></span></code></pre></div><p>可以看到这个只用了一个<code>v-dLoading</code>的自定义指令，而<code>vitepress</code>文档使用的构建方式SSR服务端渲染，SSR过程中没有相应的<code>transform</code>转换器来解析这个vue的自定义指令，所以构建文档报错啦。</p><h3 id="解决方案" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案" aria-label="Permalink to &quot;解决方案&quot;">​</a></h3><p>知道问题的原因，解决起来就很容易啦。</p><ul><li>一种方案是为这个自定义指令编写相应的transform</li><li>另一种方案是安装<a href="https://www.npmjs.com/package/patch-vue-directive-ssr" target="_blank" rel="noreferrer">patch-vue-directive-ssr</a>补丁</li></ul><p>我们选择第二种方案：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">yarn add -D patch-vue-directive-ssr</span></span></code></pre></div><p><code>patch-vue-directive-ssr</code>补丁包专门用于修补<code>@vue/compiler-ssr</code>，以使用SSR/SSG方式构建vue自定义指令。</p><h2 id="问题二-defineemit-导致的文档启动白页问题" tabindex="-1">问题二：defineEmit 导致的文档启动白页问题 <a class="header-anchor" href="#问题二-defineemit-导致的文档启动白页问题" aria-label="Permalink to &quot;问题二：defineEmit 导致的文档启动白页问题&quot;">​</a></h2><h3 id="问题背景和描述-1" tabindex="-1">问题背景和描述 <a class="header-anchor" href="#问题背景和描述-1" aria-label="Permalink to &quot;问题背景和描述&quot;">​</a></h3><p>这个问题最早发现于9月18日和村长在B站直播的那个晚上，以下是直播的录播地址：</p><p><a href="https://www.bilibili.com/video/BV1GU4y1N7eC/" target="_blank" rel="noreferrer">【我要做开源】华为大佬亲授，Vue DevUI开源指南01：提交我的第一次pr</a></p><p>这个问题发生在执行<code>yarn dev</code>命令启动组件库文档的时候，执行完<code>yarn dev</code>命令，在浏览器地址栏输入<code>http://localhost:3000/</code>访问文档，出现白页。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f97321f940ab444abb9a943bcd7dbfb5~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><h3 id="问题分析-1" tabindex="-1">问题分析 <a class="header-anchor" href="#问题分析-1" aria-label="Permalink to &quot;问题分析&quot;">​</a></h3><p>打开浏览器控制台，发现红色的报错，提示了一个语法错误：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">Uncaught SyntaxError: The requested module &#39;/vue-devui/node_modules/.vite/vue.js&#39; does not provide an export named &#39;defineEmit&#39;</span></span></code></pre></div><p>依然非常幸运，这个报错定位到了具体的文件：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">/vue-devui/sites/.vitepress/devui-theme/components/NavBar.vue</span></span></code></pre></div><p>这个文件从<code>vue</code>中导入了<code>defineEmit</code>这个方法：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">&lt;script setup lang=&quot;ts&quot;&gt;</span></span>
<span class="line"><span style="color:#babed8;">import { defineEmit } from &#39;vue&#39;</span></span>
<span class="line"><span style="color:#babed8;">import NavBarTitle from &#39;./NavBarTitle.vue&#39;</span></span>
<span class="line"><span style="color:#babed8;">import NavLinks from &#39;./NavLinks.vue&#39;</span></span>
<span class="line"><span style="color:#babed8;">import ToggleSideBarButton from &#39;./ToggleSideBarButton.vue&#39;</span></span>
<span class="line"><span style="color:#babed8;"></span></span>
<span class="line"><span style="color:#babed8;">defineEmit([&#39;toggle&#39;])</span></span>
<span class="line"><span style="color:#babed8;">&lt;/script&gt;</span></span></code></pre></div><p>错误就发生在这里。</p><p>非常巧，正好直播那天晚上，我们将<code>vue devui</code>的<code>vue</code>版本升级到了<code>vue@3.1.5</code>，从<code>3.1.5</code>这个版本开始，vue的一些api发生了变化，比如这里的<code>defineEmit -&gt; defineEmits</code>。</p><h3 id="解决方案-1" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案-1" aria-label="Permalink to &quot;解决方案&quot;">​</a></h3><p>知道了原因，答案呼之即出。</p><blockquote><p>直接把 <code>defineEmit</code> 改成 <code>defineEmits</code> 即可。</p></blockquote><p>以下是当时直播间手速最快的 <a href="https://gitee.com/hzttw" target="_blank" rel="noreferrer">hzttw</a> 同学提的 pr：</p><p><a href="https://gitee.com/devui/vue-devui/pulls/114" target="_blank" rel="noreferrer">解决启动报错问题</a></p><h2 id="问题三-使用-window-document-等浏览器变量导致的-vitepress-ssr-构建问题" tabindex="-1">问题三：使用 window/document 等浏览器变量导致的 vitepress ssr 构建问题 <a class="header-anchor" href="#问题三-使用-window-document-等浏览器变量导致的-vitepress-ssr-构建问题" aria-label="Permalink to &quot;问题三：使用 window/document 等浏览器变量导致的 vitepress ssr 构建问题&quot;">​</a></h2><h3 id="问题背景和描述-2" tabindex="-1">问题背景和描述 <a class="header-anchor" href="#问题背景和描述-2" aria-label="Permalink to &quot;问题背景和描述&quot;">​</a></h3><p>这也是一个非常典型的问题，最早发现于国庆节期间，当时我打算将 vue devui 的网站部署到域名，但我又不想购买云主机，所以打算白嫖码云的：部署到<code>gitee.io</code>域名。</p><p>部署之前得先构建网站的生产包，没想到那么久没执行<code>yarn build</code>命令，执行完直接报错了，先是包了问题一那个问题：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">SyntaxError: Custom directive is missing corresponding SSR transform and will be ignored.</span></span></code></pre></div><p>这个问题好解决，直接安装 <a href="https://www.npmjs.com/package/patch-vue-directive-ssr" target="_blank" rel="noreferrer">patch-vue-directive-ssr</a> 补丁包即可：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">yarn add -D patch-vue-directive-ssr</span></span></code></pre></div><p>安装完补丁包这个问题解决，再次构建还是出错，报了另一个错 <a href="https://gitee.com/devui/vue-devui/issues/I4D06D" target="_blank" rel="noreferrer">I4D06D</a>：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">ReferenceError: window is not defined</span></span></code></pre></div><h3 id="问题分析-2" tabindex="-1">问题分析 <a class="header-anchor" href="#问题分析-2" aria-label="Permalink to &quot;问题分析&quot;">​</a></h3><p>很不幸，这个报错没有定位到具体的文件。</p><p>以下是报错的详细信息：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">✓ building client + server bundles...</span></span>
<span class="line"><span style="color:#babed8;">✖ rendering pages...</span></span>
<span class="line"><span style="color:#babed8;">build error:</span></span>
<span class="line"><span style="color:#babed8;"> ReferenceError: window is not defined</span></span>
<span class="line"><span style="color:#babed8;">    at /vue-devui-theme/node_modules/vitepress/dist/client/app/temp/app.js:932:3</span></span>
<span class="line"><span style="color:#babed8;">    at Module.&lt;anonymous&gt; (/vue-devui-theme/node_modules/vitepress/dist/client/app/temp/app.js:937:2)</span></span>
<span class="line"><span style="color:#babed8;">    at Module._compile (internal/modules/cjs/loader.js:999:30)</span></span>
<span class="line"><span style="color:#babed8;">    at Module._extensions..js (internal/modules/cjs/loader.js:1027:10)</span></span>
<span class="line"><span style="color:#babed8;">    at extensions..js (/vue-devui-theme/node_modules/esbuild-register/dist/node.js:2696:24)</span></span>
<span class="line"><span style="color:#babed8;">    at Object.newLoader [as .js] (/vue-devui-theme/node_modules/esbuild-register/dist/node.js:2262:9)</span></span>
<span class="line"><span style="color:#babed8;">    at Module.load (internal/modules/cjs/loader.js:863:32)</span></span>
<span class="line"><span style="color:#babed8;">    at Function.Module._load (internal/modules/cjs/loader.js:708:14)</span></span>
<span class="line"><span style="color:#babed8;">    at Module.require (internal/modules/cjs/loader.js:887:19)</span></span>
<span class="line"><span style="color:#babed8;">    at require (internal/modules/cjs/helpers.js:74:18)</span></span>
<span class="line"><span style="color:#babed8;">error Command failed with exit code 1.</span></span>
<span class="line"><span style="color:#babed8;">info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.</span></span></code></pre></div><p>都是构建报错，我们对比下问题一的报错信息：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">[vite:vue] Custom directive is missing corresponding SSR transform and will be ignored.</span></span>
<span class="line"><span style="color:#babed8;">file: /Users/kagol/Documents/Kagol/code/vue-devui-theme/sites/components/loading/index.md:124:3</span></span>
<span class="line"><span style="color:#babed8;">✖ building client + server bundles...</span></span>
<span class="line"><span style="color:#babed8;">build error:</span></span>
<span class="line"><span style="color:#babed8;"> SyntaxError: Custom directive is missing corresponding SSR transform and will be ignored.</span></span>
<span class="line"><span style="color:#babed8;">    at Object.createCompilerError (/Users/kagol/Documents/Kagol/code/vue-devui-theme/node_modules/@vue/compiler-core/dist/compiler-core.cjs.js:19:19)</span></span>
<span class="line"><span style="color:#babed8;">    ...</span></span></code></pre></div><p>还是发现了一些不同，问题一的报错出现在<code>build bundles</code>阶段，而现在这个报错<code>build bundles</code>是成功的：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">✓ building client + server bundles...</span></span></code></pre></div><p>但是<code>render pages</code>阶段失败了：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">✖ rendering pages...</span></span></code></pre></div><p>这里涉及到 vitepress ssr 构建的知识。</p><p>通过阅读<code>vitepress</code>源码，我们了解到我们执行<code>vitepress build docs</code>命令时，实际上构建的过程分成两个步骤：</p><ol><li>调用<code>bundle</code>方法，使用<code>vite</code>进行<code>ssr</code>构建，也就是构建日志中的<code>building client + server bundles...</code></li><li>调用<code>renderPage</code>方法，使用<code>vue router</code>的<code>router.go(routePath)</code>进行页面的渲染，也就是构建日志中的<code>rendering pages...</code></li></ol><p>但是渲染页面的时候，<code>vitepress</code>并不知道具体是哪个文件出错，所以没法给出定位到具体文件的详细提示信息。</p><blockquote><p>这时就需要靠有经验的程序员的直觉进行问题定位了。</p></blockquote><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c70630b47014d1db6831444dfcdcc51~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>由于是服务端渲染，并没有浏览器环境，只是一个nodejs的环境，因此<code>window</code>变量肯定是不存在的，所以提示：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">ReferenceError: window is not defined</span></span></code></pre></div><p>但到底是哪个文件导致的报错呢？</p><p>先尝试全局搜索下关键字<code>window</code>，一共有20个文件包含<code>window</code>：</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6a896a1b90847cb9be8b455519ef575~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>再加个点<code>window.</code>缩小下范围，还有17个文件包含<code>window.</code>：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc911b9e15224dd781b5c4d15230f9a3~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>通过慢慢分析每一个文件，就能解决这个问题。</p><h3 id="解决方案-2" tabindex="-1">解决方案 <a class="header-anchor" href="#解决方案-2" aria-label="Permalink to &quot;解决方案&quot;">​</a></h3><p>这个棘手的问题最终由<a href="https://gitee.com/zcating" target="_blank" rel="noreferrer">Zcating</a>同学解决。</p><p><a href="https://gitee.com/devui/vue-devui/pulls/186" target="_blank" rel="noreferrer">fix(build): 修复 vitepress 打包时出现的问题</a></p><p><code>Zcating</code>同学是<code>devui</code>开源组织的核心成员，从去年<code>Ng DevUI</code>刚开始开源以来就一直非常活跃，而且给我们的掘金专栏投过6篇<code>RxJS</code>原理分析的文章，<code>vue devui</code>组件库的第一个组件<code>Button</code>就是<code>Zcating</code>同学贡献的。</p><p>除了<code>Button</code>组件，<code>Zcating</code>同学还是<code>Modal</code>/<code>Overlay</code>等多个组件的田主，不仅频繁活跃地检视代码，而且承担着<code>vue devui</code>最复杂组件<code>Table</code>的设计和开发工作。</p><p><code>Zcating</code>同学也在运营一个公众号：<code>zcx的工作室</code>，欢迎大家关注呀～</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dbfc895d48034d64ac6e4eac8085d570~tplv-k3u1fbpfcp-watermark.image?" alt="图片.png"></p><p>主要解决手段包括：</p><ol><li>定义<code>inBrowser</code>方法，在使用了window等浏览器变量的地方提前返回</li><li>将包含window等浏览器变量的代码移到<code>onMounted</code>生命周期事件中</li></ol><p>感兴趣的小伙伴可以看下<a href="https://gitee.com/zcating" target="_blank" rel="noreferrer">Zcating</a>同学的pr：</p><p><a href="https://gitee.com/devui/vue-devui/pulls/186" target="_blank" rel="noreferrer">fix(build): 修复 vitepress 打包时出现的问题</a></p>`,101);function c(r,d,u,b,m,g){const e=s("EditInfo");return n(),o("div",null,[p,t(e,{time:"2021年10月26日 00:04",title:"阅读 2684 ·  点赞 21 ·  评论 6 ·  收藏 12"})])}const f=a(i,[["render",c]]);export{h as __pageData,f as default};
